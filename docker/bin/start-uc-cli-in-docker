#!/usr/bin/env bash
set -ex;

container_version="0.1.0"
container_name="unitycatalog-cli"
network_name="unitycatalog_network"
network_details=$(docker network ls --format '{{json .}}' | jq -r --arg NETWORK_NAME "$network_name" 'select(.Name == $NETWORK_NAME) | .Name')
container_details=$(docker container ls --format '{{json .}}' | jq -r --arg CONTAINER_NAME "$container_name" 'select(.Names == $CONTAINER_NAME) | .Names')
container_running=$(docker ps --format '{{json .}}' | jq -r --arg CONTAINER_NAME "$container_name" 'select(.Names == $CONTAINER_NAME) | .Names')

# Create the network if it doesn't exist
if [ -z "$network_details" ]; then
    echo "Network $network_name does not exist. Creating it..."
    docker network create $network_name
    echo "Network $network_name created."
else
    echo "Network $network_name already exists, skipping."
fi

if [ -z "$container_details" ]; then
    echo "Container $container_name does not exist. Creating it..."
    
    docker run --rm \
       --network unitycatalog_network \
       --name "$container_name" -it "$container_name:$container_version" --server http://unitycatalog:8081


    echo "Container $container_name created."
else
    if [ -n "$container_running" ]; then
        echo "Container $container_name already running, skipping."
    else
        echo "Container $container_name already exists, starting it."
        docker start -i $container_name
    fi
fi
